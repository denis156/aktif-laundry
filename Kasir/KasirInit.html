<!-- ==================== KASIR INITIALIZATION ==================== -->
<script>
  /**
   * Kasir - Initialization & Data Loading
   */

  // Global variables
  window.pelangganData = [];
  window.layananData = [];
  window.isNewCustomer = false;
  window.selectedLayanan = null;

  // ==================== INITIALIZATION ====================

  ;(function() {
    // Set tanggal hari ini sebagai default
    var today = new Date().toISOString().split('T')[0];
    document.getElementById('kasir_tanggal').value = today;

    // Load data pelanggan dan layanan
    loadPelangganData();
    loadLayananData();

    // Set initial state
    setFieldsReadonly(false);
  })();

  // ==================== LOAD DATA FROM SERVER ====================

  function loadPelangganData() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success && result.data) {
          window.pelangganData = result.data;
          populatePelangganDropdown();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error loading pelanggan:', error);
      })
      .getActivePelanggan();
  }

  function loadLayananData() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success && result.data) {
          window.layananData = result.data;
          populateLayananDropdown();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error loading layanan:', error);
      })
      .getActiveLayanan();
  }

  // ==================== POPULATE DROPDOWNS ====================

  function populatePelangganDropdown() {
    var select = document.getElementById('kasir_pelanggan');
    if (!select) {
      console.warn('[Kasir] Element kasir_pelanggan not found - page might have changed');
      return;
    }

    select.innerHTML = '<option value="">Pilih Pelanggan</option>';

    if (!window.pelangganData || !Array.isArray(window.pelangganData)) {
      console.warn('[Kasir] pelangganData is not available');
      return;
    }

    window.pelangganData.forEach(function(item) {
      var option = document.createElement('option');
      option.value = item.id;
      option.textContent = item.nama + ' - ' + item.noHp;
      option.setAttribute('data-nama', item.nama);
      option.setAttribute('data-nohp', item.noHp);
      option.setAttribute('data-email', item.email || '');
      option.setAttribute('data-alamat', item.alamat || '');
      select.appendChild(option);
    });
  }

  function populateLayananDropdown() {
    var select = document.getElementById('kasir_layanan');
    if (!select) {
      console.warn('[Kasir] Element kasir_layanan not found - page might have changed');
      return;
    }

    select.innerHTML = '<option value="">Pilih Layanan</option>';

    if (!window.layananData || !Array.isArray(window.layananData)) {
      console.warn('[Kasir] layananData is not available');
      return;
    }

    window.layananData.forEach(function(item) {
      var option = document.createElement('option');
      option.value = item.id;
      option.textContent = item.nama + ' - Rp ' + Number(item.harga).toLocaleString('id-ID') + '/kg';
      option.setAttribute('data-nama', item.nama);
      option.setAttribute('data-harga', item.harga);
      option.setAttribute('data-durasi', item.durasi);
      select.appendChild(option);
    });
  }
</script>
