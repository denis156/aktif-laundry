<!-- ==================== MODAL COMPONENTS ==================== -->

<!-- Modal Detail Pelanggan -->
<dialog id="modal_detail_pelanggan" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Detail Pelanggan</h3>
    <div class="space-y-3">
      <div>
        <label class="font-semibold">ID Pelanggan:</label>
        <p id="detail_id" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Nama:</label>
        <p id="detail_nama" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">No. HP:</label>
        <p id="detail_nohp" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Alamat:</label>
        <p id="detail_alamat" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Email:</label>
        <p id="detail_email" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Tanggal Daftar:</label>
        <p id="detail_tanggaldaftar" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Total Transaksi:</label>
        <p id="detail_totaltransaksi" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Status:</label>
        <p id="detail_status" class="text-base-content/70"></p>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Tutup</button>
      </form>
    </div>
  </div>
</dialog>

<!-- Modal Edit Pelanggan -->
<dialog id="modal_edit_pelanggan" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Edit Pelanggan</h3>
    <form id="form_edit_pelanggan" class="space-y-4">
      <input type="hidden" id="edit_id">

      <div>
        <label class="label">
          <span class="label-text">Nama</span>
        </label>
        <input type="text" id="edit_nama" placeholder="Nama pelanggan" class="input input-bordered w-full" required />
      </div>

      <div>
        <label class="label">
          <span class="label-text">No. HP</span>
        </label>
        <input type="tel" id="edit_nohp" placeholder="08123456789" class="input input-bordered w-full" required />
      </div>

      <div>
        <label class="label">
          <span class="label-text">Alamat</span>
        </label>
        <textarea id="edit_alamat" class="textarea textarea-bordered w-full" placeholder="Alamat lengkap"></textarea>
      </div>

      <div>
        <label class="label">
          <span class="label-text">Email</span>
        </label>
        <input type="email" id="edit_email" placeholder="email@example.com" class="input input-bordered w-full" />
      </div>

      <div>
        <label class="label">
          <span class="label-text">Status</span>
        </label>
        <select id="edit_status" class="select select-bordered w-full" required>
          <option value="">Pilih status</option>
          <option value="Aktif">Aktif</option>
          <option value="Tidak Aktif">Tidak Aktif</option>
        </select>
      </div>

      <div class="modal-action">
        <button type="button" class="btn" onclick="modal_edit_pelanggan.close()">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Modal Tambah Pelanggan -->
<dialog id="modal_tambah_pelanggan" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Tambah Pelanggan</h3>
    <form id="form_tambah_pelanggan" class="space-y-4">

      <div>
        <label class="label">
          <span class="label-text">Nama</span>
        </label>
        <input type="text" id="tambah_nama" placeholder="Nama pelanggan" class="input input-bordered w-full" required />
      </div>

      <div>
        <label class="label">
          <span class="label-text">No. HP</span>
        </label>
        <input type="tel" id="tambah_nohp" placeholder="08123456789" class="input input-bordered w-full" required />
      </div>

      <div>
        <label class="label">
          <span class="label-text">Alamat</span>
        </label>
        <textarea id="tambah_alamat" class="textarea textarea-bordered w-full" placeholder="Alamat lengkap"></textarea>
      </div>

      <div>
        <label class="label">
          <span class="label-text">Email</span>
        </label>
        <input type="email" id="tambah_email" placeholder="email@example.com" class="input input-bordered w-full" />
      </div>

      <div>
        <label class="label">
          <span class="label-text">Status</span>
        </label>
        <select id="tambah_status" class="select select-bordered w-full" required>
          <option value="">Pilih status</option>
          <option value="Aktif" selected>Aktif</option>
          <option value="Tidak Aktif">Tidak Aktif</option>
        </select>
      </div>

      <div class="modal-action">
        <button type="button" class="btn" onclick="modal_tambah_pelanggan.close()">Batal</button>
        <button type="submit" class="btn btn-primary">Simpan</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Modal Konfirmasi Hapus -->
<dialog id="modal_delete_pelanggan" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Konfirmasi Hapus</h3>
    <p class="py-4">Apakah Anda yakin ingin menghapus pelanggan <strong id="delete_nama"></strong>?</p>
    <input type="hidden" id="delete_id">
    <div class="modal-action">
      <button class="btn" onclick="modal_delete_pelanggan.close()">Batal</button>
      <button class="btn btn-error" onclick="confirmDeletePelanggan()">Hapus</button>
    </div>
  </div>
</dialog>

<!-- ==================== JAVASCRIPT FUNCTIONS ==================== -->

<script>
  /**
   * Frontend JavaScript untuk halaman Pelanggan
   * Handles UI interactions, modal, dan form submissions
   */

  // ==================== MODAL FUNCTIONS ====================

  // View Detail - menggunakan data attributes dari button
  window.viewPelangganData = function(btn) {
    var data = btn.dataset;
    document.getElementById('detail_id').textContent = data.id;
    document.getElementById('detail_nama').textContent = data.nama;
    document.getElementById('detail_nohp').textContent = data.nohp;
    document.getElementById('detail_alamat').textContent = data.alamat || '-';
    document.getElementById('detail_email').textContent = data.email || '-';
    document.getElementById('detail_tanggaldaftar').textContent = data.tanggaldaftar;
    document.getElementById('detail_totaltransaksi').textContent = data.totaltransaksi + ' kali';
    document.getElementById('detail_status').textContent = data.status;

    modal_detail_pelanggan.showModal();
  }

  // Edit Pelanggan - menggunakan data attributes dari button
  window.editPelangganData = function(btn) {
    var data = btn.dataset;
    document.getElementById('edit_id').value = data.id;
    document.getElementById('edit_nama').value = data.nama;
    document.getElementById('edit_nohp').value = data.nohp;
    document.getElementById('edit_alamat').value = data.alamat || '';
    document.getElementById('edit_email').value = data.email || '';
    document.getElementById('edit_status').value = data.status;

    modal_edit_pelanggan.showModal();
  }

  // Delete Confirmation - menggunakan data attributes dari button
  window.deletePelangganConfirmData = function(btn) {
    var data = btn.dataset;
    document.getElementById('delete_id').value = data.id;
    document.getElementById('delete_nama').textContent = data.nama;
    modal_delete_pelanggan.showModal();
  }

  // Confirm Delete - Eksekusi hapus pelanggan
  window.confirmDeletePelanggan = function() {
    var id = document.getElementById('delete_id').value;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_delete_pelanggan.close();
          navigateTo('Pelanggan');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .deletePelanggan(id);
  }

  // ==================== FORM SUBMIT HANDLERS ====================

  // Handle Form Edit Submit
  function handleEditPelangganFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    var data = {
      nama: document.getElementById('edit_nama').value,
      noHp: document.getElementById('edit_nohp').value,
      alamat: document.getElementById('edit_alamat').value,
      email: document.getElementById('edit_email').value,
      status: document.getElementById('edit_status').value
    };

    var id = document.getElementById('edit_id').value;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_edit_pelanggan.close();
          navigateTo('Pelanggan');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .editPelanggan(id, data);

    return false;
  }

  // Handle Form Tambah Submit
  function handleTambahPelangganFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    var data = {
      nama: document.getElementById('tambah_nama').value,
      noHp: document.getElementById('tambah_nohp').value,
      alamat: document.getElementById('tambah_alamat').value,
      email: document.getElementById('tambah_email').value,
      status: document.getElementById('tambah_status').value
    };

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_tambah_pelanggan.close();
          document.getElementById('form_tambah_pelanggan').reset();
          navigateTo('Pelanggan');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .createPelanggan(data);

    return false;
  }

  // ==================== PAGINATION, SEARCH & FILTER ====================

  // Pagination state
  var currentPage = 1;
  var itemsPerPage = 10;
  var totalItems = 0;
  var totalPages = 1;
  var allRows = [];

  // Clear search and filter - Defined early to avoid "not defined" error
  window.clearSearchFilter = function() {
    var searchInput = document.getElementById('search_pelanggan');
    var filterSelect = document.getElementById('filter_status');

    if (searchInput) searchInput.value = '';
    if (filterSelect) filterSelect.value = '';

    initializePagination(); // Reset to original data
  };

  // Search and Filter - WITH PAGINATION - Defined early
  window.searchAndFilter = function() {
    var searchQuery = document.getElementById('search_pelanggan').value.toLowerCase();
    var statusFilter = document.getElementById('filter_status').value;
    var tbody = document.getElementById('pelangganTableBody');
    if (!tbody) return;

    var rows = tbody.querySelectorAll('tr');

    // Filter rows and store visible ones
    var filteredRows = [];
    rows.forEach(function(row) {
      // Skip empty row
      if (row.cells.length <= 1) return;

      // Get cell values for search
      var nama = row.cells[1].textContent.toLowerCase();
      var noHp = row.cells[2].textContent.toLowerCase();
      var email = row.cells[3].textContent.toLowerCase();

      // Get status from badge
      var statusCell = row.cells[5];
      var statusBadge = statusCell ? statusCell.querySelector('.badge') : null;
      var status = statusBadge ? statusBadge.textContent.trim() : '';

      // Check if search query matches
      var searchMatch = !searchQuery ||
        nama.includes(searchQuery) ||
        noHp.includes(searchQuery) ||
        email.includes(searchQuery);

      // Check if status filter matches
      var statusMatch = !statusFilter || statusFilter === '' || status === statusFilter;

      // Store matching rows
      if (searchMatch && statusMatch) {
        filteredRows.push(row);
      }
    });

    // Update allRows with filtered results
    allRows = filteredRows;
    totalItems = allRows.length;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1; // Reset to first page

    // Hide all rows first
    rows.forEach(function(row) {
      row.style.display = 'none';
    });

    // Update pagination with filtered data
    updatePagination();
  };

  // Initialize pagination on page load
  function initializePagination() {
    var tbody = document.getElementById('pelangganTableBody');
    if (!tbody) return;

    allRows = Array.from(tbody.querySelectorAll('tr')).filter(function(row) {
      return row.cells.length > 1; // Skip empty rows
    });

    totalItems = allRows.length;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1;

    updatePagination();
  }

  // Show rows for current page
  function showCurrentPage() {
    var start = (currentPage - 1) * itemsPerPage;
    var end = start + itemsPerPage;

    allRows.forEach(function(row, index) {
      if (index >= start && index < end) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  // Update pagination display
  function updatePagination() {
    // Update info text
    var start = (currentPage - 1) * itemsPerPage + 1;
    var end = Math.min(currentPage * itemsPerPage, totalItems);

    // Update desktop info
    document.getElementById('showing_start').textContent = totalItems > 0 ? start : 0;
    document.getElementById('showing_end').textContent = end;
    document.getElementById('total_items').textContent = totalItems;

    // Update mobile info
    var showingStartMobile = document.getElementById('showing_start_mobile');
    var showingEndMobile = document.getElementById('showing_end_mobile');
    var totalItemsMobile = document.getElementById('total_items_mobile');

    if (showingStartMobile) showingStartMobile.textContent = totalItems > 0 ? start : 0;
    if (showingEndMobile) showingEndMobile.textContent = end;
    if (totalItemsMobile) totalItemsMobile.textContent = totalItems;

    // Update mobile page info
    var mobileInfo = document.getElementById('page_info_mobile');
    if (mobileInfo) {
      mobileInfo.textContent = 'Page ' + currentPage;
    }

    // Update desktop pagination with page numbers
    renderDesktopPagination();

    // Show/hide rows based on current page
    showCurrentPage();
  }

  // Render desktop pagination with page numbers
  function renderDesktopPagination() {
    var container = document.getElementById('pagination_desktop');
    if (!container) return;

    container.innerHTML = '';

    // First page button
    var firstBtn = document.createElement('button');
    firstBtn.className = 'join-item btn btn-sm';
    firstBtn.textContent = '«';
    firstBtn.onclick = goToFirstPage;
    if (currentPage === 1) firstBtn.disabled = true;
    container.appendChild(firstBtn);

    // Calculate page range to show
    var maxButtons = 5; // Show max 5 page numbers
    var startPage = Math.max(1, currentPage - 2);
    var endPage = Math.min(totalPages, startPage + maxButtons - 1);

    // Adjust start if we're near the end
    if (endPage - startPage < maxButtons - 1) {
      startPage = Math.max(1, endPage - maxButtons + 1);
    }

    // Add ellipsis if needed at start
    if (startPage > 1) {
      var btn1 = document.createElement('button');
      btn1.className = 'join-item btn btn-sm';
      btn1.textContent = '1';
      btn1.onclick = function() { goToPage(1); };
      container.appendChild(btn1);

      if (startPage > 2) {
        var ellipsis1 = document.createElement('button');
        ellipsis1.className = 'join-item btn btn-sm btn-disabled';
        ellipsis1.textContent = '...';
        container.appendChild(ellipsis1);
      }
    }

    // Page number buttons
    for (var i = startPage; i <= endPage; i++) {
      var pageBtn = document.createElement('button');
      pageBtn.className = 'join-item btn btn-sm';
      if (i === currentPage) {
        pageBtn.className += ' btn-active';
      }
      pageBtn.textContent = i;
      pageBtn.onclick = (function(page) {
        return function() { goToPage(page); };
      })(i);
      container.appendChild(pageBtn);
    }

    // Add ellipsis if needed at end
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        var ellipsis2 = document.createElement('button');
        ellipsis2.className = 'join-item btn btn-sm btn-disabled';
        ellipsis2.textContent = '...';
        container.appendChild(ellipsis2);
      }

      var btnLast = document.createElement('button');
      btnLast.className = 'join-item btn btn-sm';
      btnLast.textContent = totalPages;
      btnLast.onclick = function() { goToPage(totalPages); };
      container.appendChild(btnLast);
    }

    // Last page button
    var lastBtn = document.createElement('button');
    lastBtn.className = 'join-item btn btn-sm';
    lastBtn.textContent = '»';
    lastBtn.onclick = goToLastPage;
    if (currentPage === totalPages) lastBtn.disabled = true;
    container.appendChild(lastBtn);
  }

  // Go to specific page
  function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
      currentPage = page;
      updatePagination();
    }
  }

  window.goToFirstPage = function() {
    if (currentPage > 1) {
      currentPage = 1;
      updatePagination();
    }
  };

  window.goToLastPage = function() {
    if (currentPage < totalPages) {
      currentPage = totalPages;
      updatePagination();
    }
  };

  window.goToPrevPage = function() {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
    }
  };

  window.goToNextPage = function() {
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
    }
  };

  window.changeItemsPerPage = function() {
    // Get value from desktop or mobile dropdown
    var desktopSelect = document.getElementById('items_per_page');
    var mobileSelect = document.getElementById('items_per_page_mobile');

    var newValue;
    if (window.innerWidth < 768) {
      // Mobile
      newValue = parseInt(mobileSelect.value);
      // Sync to desktop
      if (desktopSelect) desktopSelect.value = newValue;
    } else {
      // Desktop
      newValue = parseInt(desktopSelect.value);
      // Sync to mobile
      if (mobileSelect) mobileSelect.value = newValue;
    }

    itemsPerPage = newValue;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1; // Reset to first page
    updatePagination();
  };

  // ==================== INITIALIZATION ====================

  // Initialize Pelanggan page - Attach event listeners
  (function() {
    setTimeout(function() {
      // Initialize pagination
      initializePagination();

      var formEdit = document.getElementById('form_edit_pelanggan');
      var formTambah = document.getElementById('form_tambah_pelanggan');

      if (formEdit) {
        formEdit.onsubmit = handleEditPelangganFormSubmit;
      }

      if (formTambah) {
        formTambah.onsubmit = handleTambahPelangganFormSubmit;
      }
    }, 100);
  })();
</script>
