<!-- ==================== MODAL COMPONENTS ==================== -->

<!-- Modal Detail Transaksi -->
<dialog id="modal_detail_transaksi" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl">
    <h3 class="text-lg font-bold mb-4">Detail Transaksi</h3>
    <div class="grid grid-cols-2 gap-3">
      <div>
        <label class="font-semibold">ID Transaksi:</label>
        <p id="detail_id" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Tanggal Masuk:</label>
        <p id="detail_tanggalmasuk" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Pelanggan:</label>
        <p id="detail_pelanggan" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Layanan:</label>
        <p id="detail_layanan" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Berat:</label>
        <p id="detail_berat" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Harga per Kg:</label>
        <p id="detail_hargaperkg" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Subtotal:</label>
        <p id="detail_subtotal" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Diskon:</label>
        <p id="detail_diskon" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Total:</label>
        <p id="detail_total" class="text-base-content/70 font-bold text-lg"></p>
      </div>
      <div>
        <label class="font-semibold">Metode Pembayaran:</label>
        <p id="detail_metodepembayaran" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Tanggal Selesai:</label>
        <p id="detail_tanggalselesai" class="text-base-content/70"></p>
      </div>
      <div>
        <label class="font-semibold">Status:</label>
        <p id="detail_status" class="text-base-content/70"></p>
      </div>
      <div class="col-span-2">
        <label class="font-semibold">Catatan:</label>
        <p id="detail_catatan" class="text-base-content/70"></p>
      </div>
    </div>
    <div class="modal-action">
      <form method="dialog">
        <button class="btn">Tutup</button>
      </form>
    </div>
  </div>
</dialog>

<!-- Modal Edit Transaksi -->
<dialog id="modal_edit_transaksi" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl">
    <h3 class="text-lg font-bold mb-4">Edit Transaksi</h3>
    <form id="form_edit_transaksi" class="space-y-4">
      <input type="hidden" id="edit_id">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label"><span class="label-text">Tanggal Masuk</span></label>
          <input type="date" id="edit_tanggalmasuk" class="input input-bordered w-full input-sm" required />
        </div>

        <div>
          <label class="label"><span class="label-text">Pelanggan</span></label>
          <select id="edit_idpelanggan" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Pelanggan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Layanan</span></label>
          <select id="edit_idlayanan" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Layanan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Berat (Kg)</span></label>
          <input type="number" id="edit_berat" placeholder="0" class="input input-bordered w-full input-sm" required min="0.1" step="0.1" />
        </div>

        <div>
          <label class="label"><span class="label-text">Diskon</span></label>
          <input type="number" id="edit_diskon" placeholder="0" class="input input-bordered w-full input-sm" min="0" />
        </div>

        <div>
          <label class="label"><span class="label-text">Metode Pembayaran</span></label>
          <select id="edit_metodepembayaran" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Metode</option>
            <option value="Tunai">Tunai</option>
            <option value="Transfer">Transfer</option>
            <option value="QRIS">QRIS</option>
            <option value="Debit">Debit</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Tanggal Selesai</span></label>
          <input type="date" id="edit_tanggalselesai" class="input input-bordered w-full input-sm" required />
        </div>

        <div>
          <label class="label"><span class="label-text">Status</span></label>
          <select id="edit_status" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Status</option>
            <option value="Menunggu">Menunggu</option>
            <option value="Proses">Proses</option>
            <option value="Selesai">Selesai</option>
            <option value="Diambil">Diambil</option>
            <option value="Batal">Batal</option>
          </select>
        </div>

        <div class="col-span-2">
          <label class="label"><span class="label-text">Catatan</span></label>
          <textarea id="edit_catatan" class="textarea textarea-bordered w-full textarea-sm" placeholder="Catatan transaksi"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm" onclick="modal_edit_transaksi.close()">Batal</button>
        <button type="submit" class="btn btn-primary btn-sm">Simpan</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Modal Tambah Transaksi -->
<dialog id="modal_tambah_transaksi" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl">
    <h3 class="text-lg font-bold mb-4">Transaksi Baru</h3>
    <form id="form_tambah_transaksi" class="space-y-4" onreset="resetTambahForm()">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label"><span class="label-text">Tanggal Masuk</span></label>
          <input type="date" id="tambah_tanggalmasuk" class="input input-bordered w-full input-sm" required />
        </div>

        <div>
          <label class="label"><span class="label-text">Pelanggan</span></label>
          <select id="tambah_idpelanggan" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Pelanggan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Layanan</span></label>
          <select id="tambah_idlayanan" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Layanan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Berat (Kg)</span></label>
          <input type="number" id="tambah_berat" placeholder="0" class="input input-bordered w-full input-sm" required min="0.1" step="0.1" />
        </div>

        <div>
          <label class="label"><span class="label-text">Diskon</span></label>
          <input type="number" id="tambah_diskon" placeholder="0" class="input input-bordered w-full input-sm" min="0" value="0" />
        </div>

        <div>
          <label class="label"><span class="label-text">Metode Pembayaran</span></label>
          <select id="tambah_metodepembayaran" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Metode</option>
            <option value="Tunai" selected>Tunai</option>
            <option value="Transfer">Transfer</option>
            <option value="QRIS">QRIS</option>
            <option value="Debit">Debit</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Status</span></label>
          <select id="tambah_status" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Status</option>
            <option value="Menunggu" selected>Menunggu</option>
            <option value="Proses">Proses</option>
            <option value="Selesai">Selesai</option>
            <option value="Diambil">Diambil</option>
            <option value="Batal">Batal</option>
          </select>
        </div>

        <div class="col-span-2">
          <label class="label"><span class="label-text">Catatan</span></label>
          <textarea id="tambah_catatan" class="textarea textarea-bordered w-full textarea-sm" placeholder="Catatan transaksi"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm" onclick="modal_tambah_transaksi.close()">Batal</button>
        <button type="submit" class="btn btn-primary btn-sm">Simpan</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Modal Konfirmasi Hapus -->
<dialog id="modal_delete_transaksi" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    <h3 class="text-lg font-bold mb-4">Konfirmasi Hapus</h3>
    <p class="py-4">Apakah Anda yakin ingin menghapus transaksi untuk <strong id="delete_namapelanggan"></strong>?</p>
    <input type="hidden" id="delete_id">
    <div class="modal-action">
      <button class="btn" onclick="modal_delete_transaksi.close()">Batal</button>
      <button class="btn btn-error" onclick="confirmDeleteTransaksi()">Hapus</button>
    </div>
  </div>
</dialog>

<!-- ==================== JAVASCRIPT FUNCTIONS ==================== -->

<script>
  /**
   * Frontend JavaScript untuk halaman Transaksi
   */

  // ==================== GLOBAL CACHE ====================
  var cachedPelanggan = [];
  var cachedLayanan = [];
  var cachedAllLayanan = [];  // Semua layanan (termasuk tidak aktif) untuk edit
  var isDataLoaded = false;

  // ==================== PAGINATION STATE ====================
  var currentPage = 1;
  var itemsPerPage = 10;
  var totalItems = 0;
  var totalPages = 1;
  var allRows = []; // Store all table rows

  // ==================== MODAL FUNCTIONS ====================

  // View Detail
  window.viewTransaksiData = function(btn) {
    var data = btn.dataset;
    document.getElementById('detail_id').textContent = data.id;
    document.getElementById('detail_tanggalmasuk').textContent = data.tanggalmasuk;
    document.getElementById('detail_pelanggan').textContent = data.namapelanggan + ' (' + data.idpelanggan + ')';
    document.getElementById('detail_layanan').textContent = data.namalayanan + ' (' + data.idlayanan + ')';
    document.getElementById('detail_berat').textContent = data.berat + ' Kg';
    document.getElementById('detail_hargaperkg').textContent = 'Rp ' + Number(data.hargaperkg).toLocaleString('id-ID');
    document.getElementById('detail_subtotal').textContent = 'Rp ' + Number(data.subtotal).toLocaleString('id-ID');
    document.getElementById('detail_diskon').textContent = 'Rp ' + Number(data.diskon).toLocaleString('id-ID');
    document.getElementById('detail_total').textContent = 'Rp ' + Number(data.total).toLocaleString('id-ID');
    document.getElementById('detail_metodepembayaran').textContent = data.metodepembayaran;
    document.getElementById('detail_tanggalselesai').textContent = data.tanggalselesai;
    document.getElementById('detail_status').textContent = data.status;
    document.getElementById('detail_catatan').textContent = data.catatan || '-';

    modal_detail_transaksi.showModal();
  }

  // Edit Transaksi
  window.editTransaksiData = function(btn) {
    var data = btn.dataset;

    document.getElementById('edit_id').value = data.id;
    document.getElementById('edit_tanggalmasuk').value = data.tanggalmasuk;
    document.getElementById('edit_berat').value = data.berat;
    document.getElementById('edit_diskon').value = data.diskon;
    document.getElementById('edit_metodepembayaran').value = data.metodepembayaran;
    document.getElementById('edit_tanggalselesai').value = data.tanggalselesai;
    document.getElementById('edit_status').value = data.status;
    document.getElementById('edit_catatan').value = data.catatan || '';

    // Load dropdown pelanggan dan layanan
    loadPelangganForEdit(data.idpelanggan);
    loadLayananForEdit(data.idlayanan);

    modal_edit_transaksi.showModal();
  }

  // Delete Confirmation
  window.deleteTransaksiConfirmData = function(btn) {
    var data = btn.dataset;
    document.getElementById('delete_id').value = data.id;
    document.getElementById('delete_namapelanggan').textContent = data.namapelanggan;
    modal_delete_transaksi.showModal();
  }

  // Confirm Delete
  window.confirmDeleteTransaksi = function() {
    var id = document.getElementById('delete_id').value;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_delete_transaksi.close();
          navigateTo('Transaksi');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .deleteTransaksi(id);
  }

  // ==================== HELPER FUNCTIONS ====================

  // Pre-load data dari server dan cache
  function preloadDropdownData() {
    if (isDataLoaded) return;

    // Load pelanggan aktif
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success && result.data) {
          cachedPelanggan = result.data;
          checkDataLoaded();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error pre-loading pelanggan:', error);
      })
      .getActivePelanggan();

    // Load layanan aktif (untuk modal tambah)
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success && result.data) {
          cachedLayanan = result.data;
          checkDataLoaded();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error pre-loading layanan aktif:', error);
      })
      .getActiveLayanan();

    // Load SEMUA layanan (termasuk tidak aktif, untuk modal edit)
    google.script.run
      .withSuccessHandler(function(result) {
        if (result && result.success && result.data) {
          cachedAllLayanan = result.data;
          checkDataLoaded();
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error pre-loading all layanan:', error);
      })
      .getAllLayanan();
  }

  function checkDataLoaded() {
    if (cachedPelanggan.length > 0 && cachedLayanan.length > 0 && cachedAllLayanan.length > 0) {
      isDataLoaded = true;
    }
  }

  // Populate Pelanggan dropdown dari cache
  function populatePelangganDropdown(selectId, selectedId) {
    var select = document.getElementById(selectId);
    if (!select) return;

    select.innerHTML = '<option value="">Pilih Pelanggan</option>';

    cachedPelanggan.forEach(function(item) {
      var option = document.createElement('option');
      option.value = item.id;
      var noHp = item.noHp ? String(item.noHp) : '';
      option.textContent = item.nama + ' - ' + noHp;

      if (selectedId && String(item.id) === String(selectedId)) {
        option.selected = true;
      }

      select.appendChild(option);
    });
  }

  // Populate Layanan dropdown dari cache (untuk modal tambah - hanya aktif)
  function populateLayananDropdown(selectId, selectedId) {
    populateLayananDropdownFromArray(selectId, cachedLayanan, selectedId);
  }

  // Populate Layanan dropdown dari array tertentu
  function populateLayananDropdownFromArray(selectId, dataArray, selectedId) {
    var select = document.getElementById(selectId);
    if (!select) return;

    select.innerHTML = '<option value="">Pilih Layanan</option>';

    dataArray.forEach(function(item) {
      var option = document.createElement('option');
      option.value = item.id;

      // Tambahkan marker untuk layanan tidak aktif
      var statusLabel = (item.status === 'Tidak Aktif') ? ' [TIDAK AKTIF]' : '';
      option.textContent = item.nama + ' - Rp ' + Number(item.harga).toLocaleString('id-ID') + statusLabel;

      if (selectedId && String(item.id) === String(selectedId)) {
        option.selected = true;
      }

      select.appendChild(option);
    });
  }

  // Load Pelanggan dropdown untuk Edit (menggunakan cache)
  function loadPelangganForEdit(selectedId) {
    if (isDataLoaded) {
      populatePelangganDropdown('edit_idpelanggan', selectedId);
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            cachedPelanggan = result.data;
            populatePelangganDropdown('edit_idpelanggan', selectedId);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading pelanggan:', error);
        })
        .getActivePelanggan();
    }
  }

  // Load Layanan dropdown untuk Edit (menggunakan cache SEMUA layanan)
  function loadLayananForEdit(selectedId) {
    if (isDataLoaded) {
      populateLayananDropdownFromArray('edit_idlayanan', cachedAllLayanan, selectedId);
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            cachedAllLayanan = result.data;
            populateLayananDropdownFromArray('edit_idlayanan', cachedAllLayanan, selectedId);
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading layanan:', error);
        })
        .getAllLayanan();
    }
  }

  // Load Pelanggan dropdown untuk Tambah (menggunakan cache)
  function loadPelangganForTambah() {
    if (isDataLoaded) {
      populatePelangganDropdown('tambah_idpelanggan');
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            cachedPelanggan = result.data;
            populatePelangganDropdown('tambah_idpelanggan');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading pelanggan:', error);
        })
        .getActivePelanggan();
    }
  }

  // Load Layanan dropdown untuk Tambah (menggunakan cache)
  function loadLayananForTambah() {
    if (isDataLoaded) {
      populateLayananDropdown('tambah_idlayanan');
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            cachedLayanan = result.data;
            populateLayananDropdown('tambah_idlayanan');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading layanan:', error);
        })
        .getActiveLayanan();
    }
  }

  // ==================== PAGINATION FUNCTIONS ====================

  // Initialize pagination - store all rows
  function initializePagination() {
    var tbody = document.getElementById('transaksiTableBody');
    if (!tbody) return;

    allRows = Array.from(tbody.querySelectorAll('tr')).filter(function(row) {
      return row.cells.length > 1; // Skip empty rows
    });

    totalItems = allRows.length;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1;

    updatePagination();
  }

  // Update pagination display
  function updatePagination() {
    // Update info text
    var start = (currentPage - 1) * itemsPerPage + 1;
    var end = Math.min(currentPage * itemsPerPage, totalItems);

    // Update desktop info
    document.getElementById('showing_start').textContent = totalItems > 0 ? start : 0;
    document.getElementById('showing_end').textContent = end;
    document.getElementById('total_items').textContent = totalItems;

    // Update mobile info
    var showingStartMobile = document.getElementById('showing_start_mobile');
    var showingEndMobile = document.getElementById('showing_end_mobile');
    var totalItemsMobile = document.getElementById('total_items_mobile');

    if (showingStartMobile) showingStartMobile.textContent = totalItems > 0 ? start : 0;
    if (showingEndMobile) showingEndMobile.textContent = end;
    if (totalItemsMobile) totalItemsMobile.textContent = totalItems;

    // Update mobile page info
    var mobileInfo = document.getElementById('page_info_mobile');
    if (mobileInfo) {
      mobileInfo.textContent = 'Page ' + currentPage;
    }

    // Update desktop pagination with page numbers
    renderDesktopPagination();

    // Show/hide rows based on current page
    showCurrentPage();
  }

  // Render desktop pagination with page numbers
  function renderDesktopPagination() {
    var container = document.getElementById('pagination_desktop');
    if (!container) return;

    container.innerHTML = '';

    // First page button
    var firstBtn = document.createElement('button');
    firstBtn.className = 'join-item btn btn-sm';
    firstBtn.textContent = '«';
    firstBtn.onclick = goToFirstPage;
    if (currentPage === 1) firstBtn.disabled = true;
    container.appendChild(firstBtn);

    // Calculate page range to show
    var maxButtons = 5; // Show max 5 page numbers
    var startPage = Math.max(1, currentPage - 2);
    var endPage = Math.min(totalPages, startPage + maxButtons - 1);

    // Adjust start if we're near the end
    if (endPage - startPage < maxButtons - 1) {
      startPage = Math.max(1, endPage - maxButtons + 1);
    }

    // Add ellipsis if needed at start
    if (startPage > 1) {
      var btn1 = document.createElement('button');
      btn1.className = 'join-item btn btn-sm';
      btn1.textContent = '1';
      btn1.onclick = function() { goToPage(1); };
      container.appendChild(btn1);

      if (startPage > 2) {
        var ellipsis1 = document.createElement('button');
        ellipsis1.className = 'join-item btn btn-sm btn-disabled';
        ellipsis1.textContent = '...';
        container.appendChild(ellipsis1);
      }
    }

    // Page number buttons
    for (var i = startPage; i <= endPage; i++) {
      var pageBtn = document.createElement('button');
      pageBtn.className = 'join-item btn btn-sm';
      if (i === currentPage) {
        pageBtn.className += ' btn-active';
      }
      pageBtn.textContent = i;
      pageBtn.onclick = (function(page) {
        return function() { goToPage(page); };
      })(i);
      container.appendChild(pageBtn);
    }

    // Add ellipsis if needed at end
    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        var ellipsis2 = document.createElement('button');
        ellipsis2.className = 'join-item btn btn-sm btn-disabled';
        ellipsis2.textContent = '...';
        container.appendChild(ellipsis2);
      }

      var btnLast = document.createElement('button');
      btnLast.className = 'join-item btn btn-sm';
      btnLast.textContent = totalPages;
      btnLast.onclick = function() { goToPage(totalPages); };
      container.appendChild(btnLast);
    }

    // Last page button
    var lastBtn = document.createElement('button');
    lastBtn.className = 'join-item btn btn-sm';
    lastBtn.textContent = '»';
    lastBtn.onclick = goToLastPage;
    if (currentPage === totalPages) lastBtn.disabled = true;
    container.appendChild(lastBtn);
  }

  // Go to specific page
  function goToPage(page) {
    if (page >= 1 && page <= totalPages && page !== currentPage) {
      currentPage = page;
      updatePagination();
    }
  }

  // Show rows for current page
  function showCurrentPage() {
    var start = (currentPage - 1) * itemsPerPage;
    var end = start + itemsPerPage;

    allRows.forEach(function(row, index) {
      if (index >= start && index < end) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  }

  // Pagination navigation functions
  window.goToFirstPage = function() {
    if (currentPage > 1) {
      currentPage = 1;
      updatePagination();
    }
  }

  window.goToPrevPage = function() {
    if (currentPage > 1) {
      currentPage--;
      updatePagination();
    }
  }

  window.goToNextPage = function() {
    if (currentPage < totalPages) {
      currentPage++;
      updatePagination();
    }
  }

  window.goToLastPage = function() {
    if (currentPage < totalPages) {
      currentPage = totalPages;
      updatePagination();
    }
  }

  window.changeItemsPerPage = function() {
    // Get value from desktop or mobile dropdown
    var desktopSelect = document.getElementById('items_per_page');
    var mobileSelect = document.getElementById('items_per_page_mobile');

    var newValue;
    if (window.innerWidth < 768) {
      // Mobile
      newValue = parseInt(mobileSelect.value);
      // Sync to desktop
      if (desktopSelect) desktopSelect.value = newValue;
    } else {
      // Desktop
      newValue = parseInt(desktopSelect.value);
      // Sync to mobile
      if (mobileSelect) mobileSelect.value = newValue;
    }

    itemsPerPage = newValue;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1; // Reset to first page
    updatePagination();
  }

  // Search and Filter - WITH PAGINATION
  window.searchAndFilter = function() {
    var searchQuery = document.getElementById('search_transaksi').value.toLowerCase();
    var statusFilter = document.getElementById('filter_status').value;
    var tbody = document.getElementById('transaksiTableBody');
    var rows = tbody.querySelectorAll('tr');

    // Filter rows and store visible ones
    var filteredRows = [];
    rows.forEach(function(row) {
      // Skip empty row
      if (row.cells.length <= 1) return;

      // Get cell values for search (tanpa ID/No)
      var tanggal = row.cells[1].textContent.toLowerCase();
      var pelanggan = row.cells[2].textContent.toLowerCase();
      var layanan = row.cells[3].textContent.toLowerCase();
      var berat = row.cells[4].textContent.toLowerCase();
      var total = row.cells[5].textContent.toLowerCase();
      var pembayaran = row.cells[6].textContent.toLowerCase();
      var status = row.cells[7].textContent.trim();

      // Check if search query matches
      var searchMatch = !searchQuery ||
        tanggal.includes(searchQuery) ||
        pelanggan.includes(searchQuery) ||
        layanan.includes(searchQuery) ||
        berat.includes(searchQuery) ||
        total.includes(searchQuery) ||
        pembayaran.includes(searchQuery);

      // Check if status filter matches
      var statusMatch = !statusFilter || statusFilter === '' || status === statusFilter;

      // Store matching rows
      if (searchMatch && statusMatch) {
        filteredRows.push(row);
      }
    });

    // Update allRows with filtered results
    allRows = filteredRows;
    totalItems = allRows.length;
    totalPages = Math.ceil(totalItems / itemsPerPage);
    currentPage = 1; // Reset to first page

    // Hide all rows first
    rows.forEach(function(row) {
      row.style.display = 'none';
    });

    // Update pagination with filtered data
    updatePagination();
  }

  // Clear search and filter
  window.clearSearchFilter = function() {
    document.getElementById('search_transaksi').value = '';
    document.getElementById('filter_status').value = '';
    initializePagination(); // Reset to original data
  }

  // Legacy function for backward compatibility
  window.filterByStatus = function() {
    searchAndFilter();
  }

  // ==================== FORM SUBMIT HANDLERS ====================

  // Handle Form Edit Submit
  function handleEditTransaksiFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    var data = {
      tanggalMasuk: document.getElementById('edit_tanggalmasuk').value,
      idPelanggan: document.getElementById('edit_idpelanggan').value,
      idLayanan: document.getElementById('edit_idlayanan').value,
      berat: document.getElementById('edit_berat').value,
      diskon: document.getElementById('edit_diskon').value,
      metodePembayaran: document.getElementById('edit_metodepembayaran').value,
      tanggalSelesai: document.getElementById('edit_tanggalselesai').value,
      status: document.getElementById('edit_status').value,
      catatan: document.getElementById('edit_catatan').value
    };

    var id = document.getElementById('edit_id').value;

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_edit_transaksi.close();
          navigateTo('Transaksi');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .editTransaksi(id, data);

    return false;
  }

  // Handle Form Tambah Submit
  function handleTambahTransaksiFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    var data = {
      tanggalMasuk: document.getElementById('tambah_tanggalmasuk').value,
      idPelanggan: document.getElementById('tambah_idpelanggan').value,
      idLayanan: document.getElementById('tambah_idlayanan').value,
      berat: document.getElementById('tambah_berat').value,
      diskon: document.getElementById('tambah_diskon').value,
      metodePembayaran: document.getElementById('tambah_metodepembayaran').value,
      status: document.getElementById('tambah_status').value,
      catatan: document.getElementById('tambah_catatan').value
    };

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert(result.message);
          modal_tambah_transaksi.close();
          document.getElementById('form_tambah_transaksi').reset();
          navigateTo('Transaksi');
        } else {
          alert('Error: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('Error: ' + error.message);
      })
      .createTransaksi(data);

    return false;
  }

  // Reset form handler
  function resetTambahForm() {
    // Reset akan dipanggil setelah submit atau close modal
  }

  // Override showModal untuk load dropdown saat modal dibuka
  var originalShowModal = modal_tambah_transaksi.showModal;
  modal_tambah_transaksi.showModal = function() {
    originalShowModal.call(this);
    // Load dropdown SETELAH modal dibuka
    setTimeout(function() {
      loadPelangganForTambah();
      loadLayananForTambah();
    }, 200);
  };

  // ==================== INITIALIZATION ====================

  // Initialize Transaksi page
  (function() {
    setTimeout(function() {
      // PRE-LOAD dropdown data saat halaman load
      preloadDropdownData();

      // Initialize pagination
      initializePagination();

      var formEdit = document.getElementById('form_edit_transaksi');
      var formTambah = document.getElementById('form_tambah_transaksi');

      if (formEdit) {
        formEdit.onsubmit = handleEditTransaksiFormSubmit;
      }

      if (formTambah) {
        formTambah.onsubmit = handleTambahTransaksiFormSubmit;
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('tambah_tanggalmasuk').value = today;
      }
    }, 100);
  })();
</script>
