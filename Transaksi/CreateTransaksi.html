<!-- ==================== MODAL TAMBAH TRANSAKSI ==================== -->
<dialog id="modal_tambah_transaksi" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box max-w-2xl">
    <h3 class="text-lg font-bold mb-4">Transaksi Baru</h3>
    <form id="form_tambah_transaksi" class="space-y-4">

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="label"><span class="label-text">Tanggal Masuk</span></label>
          <input type="date" id="tambah_tanggalmasuk" class="input input-bordered w-full input-sm" required />
        </div>

        <div>
          <label class="label"><span class="label-text">Pelanggan</span></label>
          <select id="tambah_idpelanggan" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Pelanggan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Layanan</span></label>
          <select id="tambah_idlayanan" class="select select-bordered w-full select-sm" required onchange="calculateTotalTambah()">
            <option value="">Pilih Layanan</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Berat (Kg)</span></label>
          <input type="number" id="tambah_berat" placeholder="0" class="input input-bordered w-full input-sm" required min="0.1" step="0.1" oninput="calculateTotalTambah()" />
        </div>

        <div>
          <label class="label"><span class="label-text">Diskon</span></label>
          <input type="number" id="tambah_diskon" placeholder="0" class="input input-bordered w-full input-sm" min="0" value="0" oninput="calculateTotalTambah()" />
        </div>

        <div>
          <label class="label"><span class="label-text">Total</span></label>
          <input type="text" id="tambah_total" class="input input-sm font-bold text-success" readonly value="Rp 0" />
        </div>

        <div>
          <label class="label"><span class="label-text">Metode Pembayaran</span></label>
          <select id="tambah_metodepembayaran" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Metode</option>
            <option value="Tunai" selected>Tunai</option>
            <option value="Transfer">Transfer</option>
            <option value="QRIS">QRIS</option>
            <option value="Debit">Debit</option>
          </select>
        </div>

        <div>
          <label class="label"><span class="label-text">Status</span></label>
          <select id="tambah_status" class="select select-bordered w-full select-sm" required>
            <option value="">Pilih Status</option>
            <option value="Menunggu" selected>Menunggu</option>
            <option value="Proses">Proses</option>
            <option value="Selesai">Selesai</option>
            <option value="Diambil">Diambil</option>
            <option value="Batal">Batal</option>
          </select>
        </div>

        <div class="col-span-2">
          <label class="label"><span class="label-text">Catatan</span></label>
          <textarea id="tambah_catatan" class="textarea textarea-bordered w-full textarea-sm" placeholder="Catatan transaksi"></textarea>
        </div>
      </div>

      <div class="modal-action">
        <button type="button" class="btn btn-sm" onclick="modal_tambah_transaksi.close()">Batal</button>
        <button type="submit" class="btn btn-primary btn-sm">Simpan</button>
      </div>
    </form>
  </div>
</dialog>

<!-- ==================== SCRIPT CREATE TRANSAKSI ==================== -->
<script>
  /**
   * Create Transaksi Logic
   */

  // Load Pelanggan dropdown untuk Tambah (menggunakan cache)
  function loadPelangganForTambah() {
    if (window.isDataLoaded) {
      populatePelangganDropdown('tambah_idpelanggan');
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            window.cachedPelanggan = result.data;
            populatePelangganDropdown('tambah_idpelanggan');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading pelanggan:', error);
        })
        .getActivePelanggan();
    }
  }

  // Load Layanan dropdown untuk Tambah (menggunakan cache)
  function loadLayananForTambah() {
    if (window.isDataLoaded) {
      populateLayananDropdown('tambah_idlayanan');
    } else {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result && result.success && result.data) {
            window.cachedLayanan = result.data;
            populateLayananDropdown('tambah_idlayanan');
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading layanan:', error);
        })
        .getActiveLayanan();
    }
  }

  // Calculate Total untuk Form Tambah
  function calculateTotalTambah() {
    var layananId = document.getElementById('tambah_idlayanan').value;
    var berat = parseFloat(document.getElementById('tambah_berat').value) || 0;
    var diskon = parseFloat(document.getElementById('tambah_diskon').value) || 0;

    var hargaPerKg = 0;

    // Cari harga dari cache layanan
    if (layananId && window.cachedLayanan) {
      var layanan = window.cachedLayanan.find(function(item) {
        return item.id === layananId;
      });
      if (layanan) {
        hargaPerKg = layanan.harga;
      }
    }

    // Hitung subtotal dan total
    var subtotal = berat * hargaPerKg;
    var total = subtotal - diskon;

    // Update input total
    document.getElementById('tambah_total').value = 'Rp ' + Number(total).toLocaleString('id-ID');
  }

  // Handle Form Tambah Submit
  function handleTambahTransaksiFormSubmit(e) {
    e.preventDefault();
    e.stopPropagation();

    var data = {
      tanggalMasuk: document.getElementById('tambah_tanggalmasuk').value,
      idPelanggan: document.getElementById('tambah_idpelanggan').value,
      idLayanan: document.getElementById('tambah_idlayanan').value,
      berat: document.getElementById('tambah_berat').value,
      diskon: document.getElementById('tambah_diskon').value,
      metodePembayaran: document.getElementById('tambah_metodepembayaran').value,
      status: document.getElementById('tambah_status').value,
      catatan: document.getElementById('tambah_catatan').value
    };

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showSuccessAlert('Berhasil!', result.message);
          modal_tambah_transaksi.close();
          document.getElementById('form_tambah_transaksi').reset();
          navigateTo('Transaksi');
        } else {
          showErrorAlert('Gagal!', result.message);
        }
      })
      .withFailureHandler(function(error) {
        showErrorAlert('Kesalahan Server', error.message);
      })
      .createTransaksi(data);

    return false;
  }

  // Override showModal untuk load dropdown saat modal dibuka
  ;(function() {
    var modal = document.getElementById('modal_tambah_transaksi');
    if (!modal) return;

    var originalShowModal = modal.showModal;
    modal.showModal = function() {
      originalShowModal.call(this);
      // Load dropdown SETELAH modal dibuka
      setTimeout(function() {
        loadPelangganForTambah();
        loadLayananForTambah();
      }, 200);
    };
  })();

  // Attach form submit handler
  ;(function() {
    setTimeout(function() {
      var formTambah = document.getElementById('form_tambah_transaksi');
      if (formTambah) {
        formTambah.onsubmit = handleTambahTransaksiFormSubmit;
        // Set default date to today
        var today = new Date().toISOString().split('T')[0];
        document.getElementById('tambah_tanggalmasuk').value = today;
      }
    }, 100);
  })();
</script>
